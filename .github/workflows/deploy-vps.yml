name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Build application
      run: npm run build
    
    - name: Setup SSH
      env:
        SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_KEY }}
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_PORT: ${{ secrets.VPS_PORT }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${VPS_PORT:-22} $VPS_HOST >> ~/.ssh/known_hosts
    
    - name: Deploy to VPS
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        VPS_PORT: ${{ secrets.VPS_PORT }}
        VPS_PATH: ${{ secrets.VPS_PATH }}
      run: |
        # Sync files to VPS
        rsync -avz --delete \
          --exclude='node_modules' \
          --exclude='.git' \
          --exclude='.env' \
          --exclude='.env.local' \
          --exclude='.env.production' \
          --exclude='tmp' \
          --exclude='temp' \
          --exclude='*.log' \
          --exclude='.vscode' \
          --exclude='.idea' \
          --exclude='screenshots' \
          --exclude='.DS_Store' \
          -e "ssh -p ${VPS_PORT:-22}" \
          . ${VPS_USER}@${VPS_HOST}:${VPS_PATH}/
        
        # Install dependencies and restart application
        ssh -p ${VPS_PORT:-22} ${VPS_USER}@${VPS_HOST} << 'EOF'
          cd ${VPS_PATH}
          
          # Install production dependencies
          npm install --production
          
          # Create .env if it doesn't exist
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "Created .env file. Please configure it manually."
          fi
          
          # Restart application with PM2
          if command -v pm2 >/dev/null 2>&1; then
            pm2 restart wallestars || pm2 start server/index.js --name wallestars
            pm2 save
            echo "Application restarted with PM2"
          else
            echo "PM2 not found. Please install PM2: npm install -g pm2"
            echo "Then start the app: pm2 start server/index.js --name wallestars"
          fi
        EOF
    
    - name: Deployment Summary
      if: success()
      run: |
        echo "✅ Deployment completed successfully!"
        echo "Application should be accessible at: http://${{ secrets.VPS_HOST }}:3000"
    
    - name: Deployment Failed
      if: failure()
      run: |
        echo "❌ Deployment failed. Please check the logs above."
        echo "Common issues:"
        echo "  - SSH connection problems"
        echo "  - Incorrect VPS credentials"
        echo "  - Missing secrets in GitHub repository"
