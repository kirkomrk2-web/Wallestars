# Automated Deployment to Hostinger VPS
# This workflow builds and deploys the application to Hostinger VPS when code is pushed to main branch

name: Deploy to Hostinger VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20.x'
  APP_DIR: '/var/www/wallestars'

permissions:
  contents: read

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run security audit
      run: npm audit --audit-level=moderate || true
    
    - name: Build application
      run: npm run build
      
    - name: Run tests
      run: npm run test
    
    - name: Create deployment package
      run: |
        tar -czf deployment.tar.gz \
          dist/ \
          server/ \
          node_modules/ \
          package.json \
          package-lock.json \
          ecosystem.config.js \
          .env.example
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment.tar.gz
        retention-days: 7

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: deployment-package
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
    
    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to VPS
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        APP_DIR: ${{ env.APP_DIR }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        HOSTINGER_API_TOKEN: ${{ secrets.HOSTINGER_API_TOKEN }}
      run: |
        # Upload deployment package
        scp deployment.tar.gz $VPS_USER@$VPS_HOST:/tmp/
        
        # Execute deployment on VPS
        ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
          set -e
          
          echo "ðŸš€ Starting deployment..."
          
          # Backup current version
          if [ -d "$APP_DIR" ]; then
            echo "ðŸ“¦ Creating backup..."
            sudo cp -r $APP_DIR /var/backups/wallestars-$(date +%Y%m%d-%H%M%S)
          fi
          
          # Extract new version
          echo "ðŸ“¥ Extracting deployment package..."
          cd $APP_DIR
          sudo tar -xzf /tmp/deployment.tar.gz
          
          # Update environment variables
          echo "âš™ï¸ Updating environment configuration..."
          sudo bash -c "cat > $APP_DIR/.env << EOF
        ANTHROPIC_API_KEY='$ANTHROPIC_API_KEY'
        HOSTINGER_API_TOKEN='$HOSTINGER_API_TOKEN'
        PORT=3000
        NODE_ENV=production
        ENABLE_COMPUTER_USE=true
        ENABLE_ANDROID=false
        EOF"
          
          # Set permissions
          sudo chown -R wallestars:wallestars $APP_DIR
          sudo chmod 600 $APP_DIR/.env
          
          # Restart application with PM2
          echo "â™»ï¸ Restarting application..."
          sudo -u wallestars pm2 restart wallestars || sudo -u wallestars pm2 start ecosystem.config.js --env production
          
          # Cleanup
          rm /tmp/deployment.tar.gz
          
          echo "âœ… Deployment completed successfully!"
          
          # Show application status
          sudo -u wallestars pm2 status wallestars
        ENDSSH
    
    - name: Health check
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
      run: |
        echo "ðŸ” Running health check..."
        sleep 10
        
        # Check if application is responding (with SSL verification)
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://$VPS_HOST/api/health || echo "000")
        
        if [ "$RESPONSE" = "200" ]; then
          echo "âœ… Application is healthy!"
        else
          echo "âŒ Health check failed with status: $RESPONSE"
          exit 1
        fi
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
        fi

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    permissions:
      contents: read
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
    
    - name: Rollback to previous version
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        APP_DIR: ${{ env.APP_DIR }}
      run: |
        ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
          set -e
          
          echo "âš ï¸ Initiating rollback..."
          
          # Find latest backup
          LATEST_BACKUP=$(ls -t /var/backups/wallestars-* | head -1)
          
          if [ -z "$LATEST_BACKUP" ]; then
            echo "âŒ No backup found for rollback!"
            exit 1
          fi
          
          echo "ðŸ“¦ Restoring from backup: $LATEST_BACKUP"
          
          # Restore backup
          sudo rm -rf $APP_DIR
          sudo cp -r $LATEST_BACKUP $APP_DIR
          sudo chown -R wallestars:wallestars $APP_DIR
          
          # Restart application
          sudo -u wallestars pm2 restart wallestars
          
          echo "âœ… Rollback completed!"
          sudo -u wallestars pm2 status wallestars
        ENDSSH
